# Starter pipeline

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: ubuntu-latest

steps:
- script: |
    set -o xtrace
    export VCPKG_ROOT=/usr/local/share/pxmc3000/vcpkg
    export PXMC_ROOT=/usr/local/share/pxmc3000
    if [ ! -d $PXMC_ROOT ]; then sudo install -d -o vsts -g docker /usr/local/share/pxmc3000; fi
    git clone https://github.com/Microsoft/vcpkg
    cd vcpkg
    ./bootstrap-vcpkg.sh -disableMetrics
    ./vcpkg integrate install --vcpkg-root $VCPKG_ROOT
    ./vcpkg @../SmpDataAgent/vcpkg_ref.txt --vcpkg-root $VCPKG_ROOT
  displayName: 'Prepare the environment & VCPKG packages'
- script: |
    echo Step 1: installing packages with apt ...
    sudo apt install -y ninja-build cmake libcurl4-openssl-dev
  displayName: 'Install required package - apt'
- script: |
    sudo cmake /home/vsts/work/1/s/  --preset linux-debug -DCMAKE_TOOLCHAIN_FILE:FILEPATH="/usr/local/share/vcpkg/scripts/buildsystems/vcpkg.cmake"
    sudo cmake --build /usr/local/share/pxmc3000/SmpDataAgent/bin/linux-debug --config Release
  displayName: 'Cmake build'
- script: |
    sudo cp /usr/local/share/pxmc3000/SmpDataAgent/bin/linux-debug/SmpDataAgent/SmpDataAgent /home/vsts/work/1/a/SmpDataAgent
  displayName: 'Copy binaries'
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'SmpDataAgent'
    publishLocation: 'Container'
  displayName: 'Publish Binarie'